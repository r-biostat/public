以下は、前述の解析方針に基づき、Rコードを作成・実行するための解析手順書（Markdown形式）です。コード例は含まず、自然言語で各ステップの詳細な内容とその意図を説明しています。

---

# 解析手順書: 後ろ向きコホート研究データを用いた大腸がんStage IV患者の2年死亡率解析

本手順書は、免疫チェックポイント阻害薬の併用が2年死亡率に与える影響を評価するため、Rを用いた解析プロセスを詳細に記述したものです。解析は主にCox比例ハザードモデルを中心に、傾向スコア法（PSM、IPTW）および補助的な多変量ロジスティック回帰解析を併用して実施します。また、欠測データの処理についても多重インプテーションを適用し、感度分析を行います。

## 1. データ読み込みと前処理

### 1.1 CSVデータのインポート
- **目的:** 患者ごとの情報（PatientID, Age, Sex, PerformanceStatus, LymphNodeCount, TumorSize, ICI_Therapy, FollowUpMonths, Event）を含むCSVファイルを読み込み、解析用データフレームを作成する。
- **ポイント:** ヘッダー行の存在、変数の型（数値、カテゴリなど）の確認を行い、必要に応じて適切な型に変換する。

### 1.2 欠測データの確認と処理
- **目的:** 各変数の欠測値の有無を確認し、欠測パターンの検査を行う。
- **手順:** 
  - 欠測値の分布とそのパターンを可視化する（例: 欠測マトリックスの作成）。
  - 欠測がランダムかどうかを検討し、もし欠測が散発的でなくシステマティックな場合は注意する。
  - 多重インプテーション（multiple imputation）を用いて欠測値を補完する。複数の補完データセットを作成し、後続の解析で統合して推定を行う。

### 1.3 変数の整形と前処理
- **目的:** 解析に必要な変数（連続変数、カテゴリ変数）の整形や必要な変換を行う。
- **手順:** 
  - 性別（Sex）はカテゴリ変数として定義（または数値コードに変換）。
  - 必要に応じて、PerformanceStatus、リンパ節転移数、腫瘍サイズなどの交絡因子の分布確認と変数変換（例: 対数変換やカテゴリ化）を検討する。
  - FollowUpMonthsとEventの変数で生存情報が正しく記録されているか確認する。

## 2. 記述統計とデータ確認

### 2.1 基本統計量の計算
- **目的:** 各変数の基本統計量（平均、中央値、標準偏差、頻度分布など）を算出し、データの概観を把握する。
- **手順:** 
  - 数値変数について、中心傾向と分散を確認。
  - カテゴリ変数について、各カテゴリーの頻度・割合を算出する。

### 2.2 グループ間の比較
- **目的:** ICI_Therapy群（併用あり）と非併用群で交絡因子（年齢、性別、PS、リンパ節転移数、腫瘍サイズ）の分布がどの程度異なるかを確認する。
- **手順:** 
  - クロス集計やt検定、非パラメトリック検定などを用い、グループ間の差を検定する。

## 3. 傾向スコアの推定と交絡調整

### 3.1 傾向スコアの算出
- **目的:** ICI_Therapyの治療割り付けを説明するため、交絡因子を用いて傾向スコアを推定する。
- **手順:** 
  - ロジスティック回帰モデルを構築し、治療介入の確率を算出する。
  - 傾向スコアの分布とその重なり具合（オーバーラップ）を可視化し、治療群間のバランスを確認する。

### 3.2 傾向スコアマッチング（PSM）によるデータサブセットの作成
- **目的:** 傾向スコアに基づき、ICI_Therapy群と非併用群を1対1（またはその他のマッチング比率）でマッチングし、交絡因子のバランスを取る。
- **手順:** 
  - マッチングアルゴリズム（例えばNearest Neighbor）を用いてマッチングを実施。
  - マッチング後、交絡因子のバランスが改善されたかを評価する（標準化平均差、バランスプロットなど）。

### 3.3 逆確率重み付け（IPTW）による重み付け解析
- **目的:** 傾向スコアを利用して全症例に対して重みを付与し、交絡因子のバランスがとれた疑似母集団を作成する。
- **手順:** 
  - 各症例に対して、介入群・非介入群それぞれの逆確率重みを算出する。
  - 重み付け後の交絡因子の分布を確認し、バランスが達成されているか検証する。

## 4. 生存解析

### 4.1 Cox比例ハザードモデルの実行（主解析）
- **目的:** FollowUpMonthsとEventを用い、ICI_Therapyの効果を調整済みハザード比として評価する。
- **手順:** 
  - 多変量Cox回帰モデルにおいて、治療変数と交絡因子（Age, Sex, PerformanceStatus, LymphNodeCount, TumorSize）を共変量として投入する。
  - ハザード比（HR）と95%信頼区間、p値を算出する。
  - プロポーションハザードの仮定が成立しているか、残差解析などを用いて検証する。

### 4.2 傾向スコアを用いたCox解析
- **目的:** 傾向スコアマッチングまたはIPTWによって交絡因子のバランスを調整した上で、再度Coxモデルを実施し、主解析との結果の整合性を評価する。
- **手順:** 
  - マッチング後のサブセットに対してCoxモデルを実行する。もしくは、IPTW重みを用いた加重Coxモデルを実施する。
  - 得られたハザード比と信頼区間を報告し、主解析との比較を行う。

### 4.3 補助的な2年時点のロジスティック回帰解析
- **目的:** 2年以内の死亡という二値アウトカムに対するICI_Therapyの効果を、補助的に評価する。
- **手順:** 
  - FollowUpMonthsが24ヶ月以下の症例で、Eventが1の場合を死亡、Eventが0の場合を生存とみなし、2年死亡率を定義する。
  - 多変量ロジスティック回帰モデルにおいて、治療変数と交絡因子を共変量として投入する。
  - オッズ比（OR）と95%信頼区間、p値を算出し、結果の一貫性を確認する。

## 5. 結果の統合と感度分析

### 5.1 主解析と補助解析結果の統合
- **目的:** 複数手法（Coxモデル、PSM/IPTWを用いたCox、ロジスティック回帰）の結果を統合し、全体としての治療効果の頑健性を評価する。
- **手順:** 
  - 各解析で得られた効果推定（HRまたはOR）とその信頼区間、p値を表やグラフにまとめる。
  - 複数手法の結果が方向性および統計的有意性で一致しているかを検討する。

### 5.2 感度分析
- **目的:** 欠測データの補完方法や交絡因子の調整方法による結果の変動を検討し、結果の頑健性を確認する。
- **手順:** 
  - 多重インプテーションを用いない場合と用いた場合の結果の比較を実施する。
  - 傾向スコアの仕様（例えば、マッチング法、重み付けのアルゴリズム）を変えた解析を実施し、結果の安定性を確認する。

## 6. 結果の報告と解釈

### 6.1 主解析結果の報告
- **目的:** Coxモデルによる調整済みハザード比を中心に、ICI_Therapyが2年死亡率に及ぼす影響を報告する。
- **内容:** 
  - ハザード比、95%信頼区間、p値
  - 生存曲線（カプランマイヤー曲線）およびログランク検定の結果

### 6.2 補助解析および感度分析結果の報告
- **目的:** 補助的なロジスティック回帰解析や傾向スコア法を用いた解析結果を提示し、主解析結果の妥当性を裏付ける。
- **内容:** 
  - マッチング後またはIPTWを用いたCox解析の結果
  - 2年時点でのロジスティック回帰解析によるオッズ比
  - 欠測データ処理や傾向スコアの仕様変更による結果の変動についての考察

### 6.3 バイアスや限界の記述
- **目的:** 観察研究特有の交絡、選択バイアス、情報バイアスの可能性、欠測データ補完の仮定など、研究上の制約を明確に述べる。
- **内容:** 
  - 未調整の未知の交絡因子の可能性
  - 選択バイアス、測定誤差の影響
  - 感度分析によって確認された結果の安定性の説明

## 7. 最終的な解析フローの確認

1. **データインポートと前処理**  
   - CSVファイルの読み込み、型変換、欠測データの確認と多重インプテーションによる補完  
2. **記述統計とグループ間比較**  
   - 基本統計量と交絡因子の分布確認  
3. **傾向スコアの推定**  
   - ロジスティック回帰による傾向スコアの算出、PSMおよびIPTWによる交絡調整  
4. **生存解析の実施**  
   - 主解析: 多変量Cox比例ハザードモデルの実行  
   - 補助解析: 傾向スコアを用いた加重解析および2年死亡率のロジスティック回帰  
5. **結果の統合、感度分析、報告**  
   - 各解析結果の統合と感度分析の実施、解釈とバイアスの記述

---

この手順書に沿って、Rで各解析ステップのコードを作成・実行することで、観察研究データから交絡調整済みの2年死亡率に対するICI_Therapyの効果を包括的に評価することができます。医学研究者が解析手法の前提と限界を十分に理解しつつ、臨床的意義を正しく評価できるような解析設計となることを目指してください。
# AIへの指示
- プログラミング言語はRを使用する。
- パッケージをインストールするときは別のRファイルを作成して実行する
- CRANミラーの設定をinstall_packages.Rで行う
- コードには初心者でもわかりやすいように#コメントをつける

# ライブラリの読み込み
必要なパッケージをlibrary関数で読み込む

# データハンドリング
## データの読み込み
- datasheet.csvを読み込む
- 各変数のデータ形式を確認する
- データの欠損値を確認する
- データに異常値がないか確認する

## 欠測値の処理
- HbA1cが実数値ではないデータを欠測値とする
- HbA1cの欠測値はLOCF法で補完する

## データ形式の変換
- visit_dateを文字列型から日付型に変換
- regular_exerciseを数値型から因子型に変換

## 新規変数の作成
- BMIを計算しbmi列を作成する
- クレアチニン (CRE) 値と年齢と体重からクレアチニンクリアランスを計算し、CrCL列を作成する。女性は0.85をかける。
- 患者ごとに最初のvisit_dateが入るfirst_visit_date列を作成する
- 患者ごとに最後のvisit_dateが入るlast_visit_date列を作成する
- HbA1cが7以上になった場合1、それ以外は0とする"event"列を作成する

## 除外基準該当患者を除外
- 初回来院日にHbA1cが7以上の患者は除外
- 初回来院日にHbA1cが欠測の患者は除外

## データフレームの作成
### baselineデータフレームの作成
- 患者ごとに初回のデータを抽出した"baseline"データフレームを作成する

### event_dateデータフレームの作成
- 患者ごとに、初めてeventが1になったデータを抽出した"event_date"データフレームを作成する。
- ID, visit_date, eventの3つの列を抽出し、それぞれID, event_date, statusという名前をつける。

### df_mergedデータフレームの作成
- baselineデータフレームにevent_dateデータフレームを左結合した"df_merged"データフレームを作成する。
- status列がNAのデータは0とする。
- 下記の条件でtime列を作成する。
  - status列がNAのデータはfirst_visit_dateからlast_visit_dateまでの期間(数値)とする。
  - status列が1のデータはfirst_visit_dateからevent_dateまでの期間(数値)とする。

# 解析
# 解析1: 患者背景表の作成
- baselineデータフレームを用いて、intervで群分けした患者背景表を作成する。
- 背景表には、age、sex、smoke、drink、CrCL(30未満、30-60、60以上)、BMI、運動習慣のデータを含める。
- ageは連続値のデータに加えて、40歳以下、41-60歳、61-80歳、81歳以上の4つのカテゴリーに分けたものも含める。
- CrCLは連続値のデータに加えて、30未満、30-60、60以上の3つのカテゴリーに分けたものも含める。
- 連続変数は中央値 (25%点, 75%点)で要約する。
- カテゴリカル変数は頻度と割合を表示する。


# 解析2: 生存時間解析
## 解析2-1: カプランマイヤー曲線の作成
- イベントの有無をevent, 観察期間をtimeとして、カプランマイヤー曲線を作成する。グラフには95%信頼区間とat risk表を表示する。

## 解析2-2: Cox比例ハザードモデル
- intervを説明変数としたCox比例ハザードモデルを作成する。モデルにはage,sex,race,smoke,drink,CrCL,bmi,regular_exercise,およびintervとregular_exerciseの交互作用項を含める。
- モデルの結果をtbl_summary関数で要約する。ハザード比、95%信頼区間、p値を表示する。

# 解析2-3: サブグループごとのカプランマイヤー曲線の作成
- regular_exerciseのサブグループごとにintervで群分けしたカプランマイヤー曲線を作成する。



